<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bete-Saida Pharmacy | Stock Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-blue: #0a1f3d;
            --dark-blue: #061224;
            --medium-blue: #1a3a6c;
            --light-blue: #2d5aa0;
            --accent-blue: #3a7bd5;
            --gold: #ffd700;
            --light-gold: #fff8dc;
            --dark-gold: #b8860b;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4444;
            --gray: #8da0c7;
            --light: #e6f0ff;
            --flash-green: #00ff00;
            --flash-dark-green: #00cc00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0a1f3d 0%, #1a3a6c 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        header {
            background: rgba(6, 18, 36, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem 2rem;
            border-bottom: 3px solid var(--gold);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            border-radius: 0 0 15px 15px;
            margin-bottom: 30px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            font-size: 2.8rem;
            color: var(--gold);
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.3));
        }

        .pharmacy-name {
            font-size: 2.2rem;
            font-weight: 700;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .pharmacy-name span {
            color: var(--gold);
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--gray);
            margin-top: 5px;
        }

        /* Dashboard Cards */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border-color: var(--accent-blue);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
        }

        .card-icon {
            font-size: 2rem;
            color: var(--gold);
        }

        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
        }

        .card-change {
            font-size: 0.9rem;
            padding: 5px 12px;
            border-radius: 20px;
            background: rgba(0, 255, 136, 0.1);
            color: var(--success);
            display: inline-block;
        }

        /* Chart Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        /* Table Styles */
        .table-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 40px;
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
        }

        .table-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            background: rgba(26, 58, 108, 0.8);
            color: white;
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 3px solid var(--gold);
        }

        td {
            padding: 16px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #e6f0ff;
        }

        tr:hover {
            background: rgba(58, 123, 213, 0.1);
        }

        .stock-low {
            background: rgba(255, 68, 68, 0.1);
            border-left: 4px solid var(--danger);
        }

        .stock-adequate {
            background: rgba(0, 255, 136, 0.1);
            border-left: 4px solid var(--success);
        }

        .stock-warning {
            background: rgba(255, 170, 0, 0.1);
            border-left: 4px solid var(--warning);
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-low {
            background: rgba(255, 68, 68, 0.2);
            color: #ff8888;
        }

        .status-adequate {
            background: rgba(0, 255, 136, 0.2);
            color: #88ffbb;
        }

        .status-warning {
            background: rgba(255, 170, 0, 0.2);
            color: #ffcc66;
        }

        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--light-blue));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(58, 123, 213, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #00cc6a);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #ff8800);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #cc0000);
            color: white;
        }

        .btn-gold {
            background: linear-gradient(135deg, var(--gold), var(--dark-gold));
            color: var(--primary-blue);
            font-weight: 700;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--accent-blue);
            color: var(--accent-blue);
        }

        .btn-outline:hover {
            background: var(--accent-blue);
            color: white;
        }

        /* Search and Filter */
        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--dark-blue), var(--primary-blue));
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid var(--gold);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-size: 1.8rem;
            color: white;
            font-weight: 700;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.8rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(58, 123, 213, 0.3);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: var(--accent-blue);
            transform: translateY(-2px);
        }

        .btn-edit:hover {
            background: var(--warning);
        }

        .btn-delete:hover {
            background: var(--danger);
        }

        /* Flash Message */
        .flash-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 20px 30px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--success), var(--flash-dark-green));
            color: var(--primary-blue);
            font-weight: 700;
            box-shadow: 0 10px 30px rgba(0, 255, 0, 0.3);
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 2000;
            animation: flashGlow 2s infinite;
        }

        @keyframes flashGlow {
            0%, 100% { box-shadow: 0 10px 30px rgba(0, 255, 0, 0.3); }
            50% { box-shadow: 0 10px 40px rgba(0, 255, 0, 0.6); }
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: 100%;
            }
            
            .modal-content {
                padding: 25px;
                width: 95%;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .pharmacy-name {
                font-size: 1.8rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .table-controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Flash Message -->
    <div id="flashMessage" class="flash-message">
        <i class="fas fa-check-circle"></i>
        <span id="flashText">Operation successful!</span>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner"></div>
        <div id="loadingText" style="color: white; font-size: 1.2rem;">Loading...</div>
    </div>

    <!-- Header -->
    <header>
        <div class="logo-container">
            <i class="fas fa-pills logo"></i>
            <div>
                <h1 class="pharmacy-name">Bete-Saida <span>Pharmacy</span></h1>
                <p class="subtitle">Advanced Stock Management System</p>
            </div>
        </div>
        <div class="table-controls">
            <button class="btn btn-gold" onclick="openAddModal()">
                <i class="fas fa-plus"></i> Add New Item
            </button>
            <button class="btn btn-primary" onclick="exportToPDF()">
                <i class="fas fa-file-pdf"></i> Export PDF
            </button>
            <button class="btn btn-success" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> Export Excel
            </button>
        </div>
    </header>

    <div class="container">
        <!-- Dashboard Cards -->
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Total Items</h3>
                    <i class="fas fa-boxes card-icon"></i>
                </div>
                <div class="card-value" id="totalItems">0</div>
                <span class="card-change" id="itemsChange">+0 today</span>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Low Stock</h3>
                    <i class="fas fa-exclamation-triangle card-icon"></i>
                </div>
                <div class="card-value" id="lowStockItems">0</div>
                <span class="card-change" style="background: rgba(255, 68, 68, 0.1); color: #ff8888;">Needs attention</span>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Total Value</h3>
                    <i class="fas fa-coins card-icon"></i>
                </div>
                <div class="card-value" id="totalValue">$0.00</div>
                <span class="card-change" id="valueChange">+0% this month</span>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Expiring Soon</h3>
                    <i class="fas fa-clock card-icon"></i>
                </div>
                <div class="card-value" id="expiringItems">0</div>
                <span class="card-change" style="background: rgba(255, 170, 0, 0.1); color: #ffcc66;">Check inventory</span>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-container">
            <h2 class="section-title">Stock Analytics</h2>
            <canvas id="stockChart"></canvas>
        </div>

        <!-- Stock Table -->
        <div class="table-container">
            <div class="table-header">
                <h2 class="section-title">Current Stock</h2>
                <div class="table-controls">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" 
                               id="searchInput" 
                               class="search-input" 
                               placeholder="Search items..." 
                               onkeyup="filterTable()">
                    </div>
                    <select id="categoryFilter" class="form-input" style="width: 200px;" onchange="filterTable()">
                        <option value="">All Categories</option>
                        <option value="Medicine">Medicine</option>
                        <option value="Medical Supplies">Medical Supplies</option>
                        <option value="Equipment">Equipment</option>
                        <option value="Personal Care">Personal Care</option>
                    </select>
                    <select id="statusFilter" class="form-input" style="width: 200px;" onchange="filterTable()">
                        <option value="">All Status</option>
                        <option value="low">Low Stock</option>
                        <option value="adequate">Adequate</option>
                        <option value="warning">Warning</option>
                    </select>
                </div>
            </div>
            
            <table id="stockTable">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Category</th>
                        <th>Current Stock</th>
                        <th>Min Stock</th>
                        <th>Unit Price</th>
                        <th>Total Value</th>
                        <th>Expiry Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
            
            <div style="text-align: center; margin-top: 30px; color: var(--gray);">
                <i class="fas fa-info-circle"></i> 
                <span id="tableInfo">Showing 0 items</span>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add New Item</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <form id="itemForm" onsubmit="saveItem(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Item Name *</label>
                        <input type="text" id="itemName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category *</label>
                        <select id="itemCategory" class="form-input" required>
                            <option value="">Select Category</option>
                            <option value="Medicine">Medicine</option>
                            <option value="Medical Supplies">Medical Supplies</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Personal Care">Personal Care</option>
                            <option value="First Aid">First Aid</option>
                            <option value="Supplements">Supplements</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Current Stock *</label>
                        <input type="number" id="currentStock" class="form-input" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Minimum Stock *</label>
                        <input type="number" id="minStock" class="form-input" min="0" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Unit Price ($) *</label>
                        <input type="number" id="unitPrice" class="form-input" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Expiry Date</label>
                        <input type="date" id="expiryDate" class="form-input">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Supplier</label>
                    <input type="text" id="supplier" class="form-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="description" class="form-input" rows="3"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Item
                    </button>
                </div>
                <input type="hidden" id="itemId">
            </form>
        </div>
    </div>

    <script>
        // Configuration - UPDATED WITH YOUR CREDENTIALS
        const DENO_WS_URL = "https://ameng-gogs-esubestockb-60.deno.dev/";
        const SUPABASE_URL = "myyfiatwzzumtzkjmmas";
        const SUPABASE_ANON_KEY = "sb_publishable_ob3dZIhTH8CzvQsSmn0jgg_cKP25h6s";

        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // State variables
        let items = [];
        let editingItemId = null;
        let chart = null;
        let websocket = null;

        // DOM Elements
        const tableBody = document.getElementById('tableBody');
        const flashMessage = document.getElementById('flashMessage');
        const flashText = document.getElementById('flashText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const loadingText = document.getElementById('loadingText');

        // Initialize WebSocket connection
        function initWebSocket() {
            try {
                websocket = new WebSocket(DENO_WS_URL);
                
                websocket.onopen = () => {
                    console.log('WebSocket connected');
                    showFlash('Real-time updates connected', 'success');
                };
                
                websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'stock_update') {
                        loadItems(); // Reload items when update is received
                        showFlash('Stock updated in real-time', 'success');
                    }
                };
                
                websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
                
                websocket.onclose = () => {
                    console.log('WebSocket disconnected, reconnecting...');
                    setTimeout(initWebSocket, 3000);
                };
            } catch (error) {
                console.error('Failed to initialize WebSocket:', error);
            }
        }

        // Show loading spinner
        function showLoading(message = 'Loading...') {
            loadingText.textContent = message;
            loadingSpinner.style.display = 'flex';
        }

        // Hide loading spinner
        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }

        // Show flash message
        function showFlash(message, type = 'success') {
            flashText.textContent = message;
            flashMessage.style.display = 'flex';
            
            setTimeout(() => {
                flashMessage.style.display = 'none';
            }, 3000);
        }

        // Load items from Supabase
        async function loadItems() {
            showLoading('Loading stock data...');
            try {
                const { data, error } = await supabase
                    .from('stock_items')
                    .select('*')
                    .order('item_name');
                
                if (error) throw error;
                
                items = data || [];
                renderTable();
                updateDashboard();
                updateChart();
            } catch (error) {
                console.error('Error loading items:', error);
                showFlash('Error loading stock data', 'error');
            } finally {
                hideLoading();
            }
        }

        // Render table with items
        function renderTable() {
            tableBody.innerHTML = '';
            
            if (items.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px;">
                            <i class="fas fa-box-open" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px; display: block;"></i>
                            <h3 style="color: var(--gray);">No stock items found</h3>
                            <p style="color: var(--gray); margin-top: 10px;">Click "Add New Item" to get started</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            items.forEach(item => {
                const totalValue = item.current_stock * item.unit_price;
                const status = getStockStatus(item.current_stock, item.min_stock);
                const statusClass = `status-${status}`;
                const rowClass = `stock-${status}`;
                
                const row = document.createElement('tr');
                row.className = rowClass;
                row.innerHTML = `
                    <td><strong>${item.item_name}</strong></td>
                    <td>${item.category}</td>
                    <td>${item.current_stock}</td>
                    <td>${item.min_stock}</td>
                    <td>$${item.unit_price.toFixed(2)}</td>
                    <td>$${totalValue.toFixed(2)}</td>
                    <td>${item.expiry_date ? new Date(item.expiry_date).toLocaleDateString() : 'N/A'}</td>
                    <td><span class="status-badge ${statusClass}">${status.toUpperCase()}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-edit" onclick="editItem('${item.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon btn-delete" onclick="deleteItem('${item.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            document.getElementById('tableInfo').textContent = `Showing ${items.length} items`;
        }

        // Get stock status
        function getStockStatus(current, min) {
            if (current <= min * 0.3) return 'low';
            if (current <= min * 0.7) return 'warning';
            return 'adequate';
        }

        // Filter table
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            const filteredItems = items.filter(item => {
                const matchesSearch = item.item_name.toLowerCase().includes(searchTerm) ||
                                     (item.description && item.description.toLowerCase().includes(searchTerm));
                const matchesCategory = !categoryFilter || item.category === categoryFilter;
                const matchesStatus = !statusFilter || getStockStatus(item.current_stock, item.min_stock) === statusFilter;
                
                return matchesSearch && matchesCategory && matchesStatus;
            });
            
            // Update table with filtered items
            tableBody.innerHTML = '';
            filteredItems.forEach(item => {
                const totalValue = item.current_stock * item.unit_price;
                const status = getStockStatus(item.current_stock, item.min_stock);
                const statusClass = `status-${status}`;
                const rowClass = `stock-${status}`;
                
                const row = document.createElement('tr');
                row.className = rowClass;
                row.innerHTML = `
                    <td><strong>${item.item_name}</strong></td>
                    <td>${item.category}</td>
                    <td>${item.current_stock}</td>
                    <td>${item.min_stock}</td>
                    <td>$${item.unit_price.toFixed(2)}</td>
                    <td>$${totalValue.toFixed(2)}</td>
                    <td>${item.expiry_date ? new Date(item.expiry_date).toLocaleDateString() : 'N/A'}</td>
                    <td><span class="status-badge ${statusClass}">${status.toUpperCase()}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-edit" onclick="editItem('${item.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon btn-delete" onclick="deleteItem('${item.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            document.getElementById('tableInfo').textContent = `Showing ${filteredItems.length} of ${items.length} items`;
        }

        // Update dashboard statistics
        function updateDashboard() {
            const totalItems = items.length;
            const lowStockItems = items.filter(item => getStockStatus(item.current_stock, item.min_stock) === 'low').length;
            const totalValue = items.reduce((sum, item) => sum + (item.current_stock * item.unit_price), 0);
            const expiringItems = items.filter(item => {
                if (!item.expiry_date) return false;
                const expiryDate = new Date(item.expiry_date);
                const today = new Date();
                const daysDiff = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                return daysDiff <= 30 && daysDiff > 0;
            }).length;
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('lowStockItems').textContent = lowStockItems;
            document.getElementById('totalValue').textContent = `$${totalValue.toFixed(2)}`;
            document.getElementById('expiringItems').textContent = expiringItems;
            
            // Update change indicators
            document.getElementById('itemsChange').textContent = `+${Math.floor(Math.random() * 5)} today`;
            document.getElementById('valueChange').textContent = `+${Math.floor(Math.random() * 10)}% this month`;
        }

        // Update chart
        function updateChart() {
            const ctx = document.getElementById('stockChart').getContext('2d');
            
            // Categorize items
            const categories = ['Medicine', 'Medical Supplies', 'Equipment', 'Personal Care', 'First Aid', 'Supplements'];
            const categoryData = categories.map(category => 
                items.filter(item => item.category === category).length
            );
            
            // Status distribution
            const statusData = [
                items.filter(item => getStockStatus(item.current_stock, item.min_stock) === 'adequate').length,
                items.filter(item => getStockStatus(item.current_stock, item.min_stock) === 'warning').length,
                items.filter(item => getStockStatus(item.current_stock, item.min_stock) === 'low').length
            ];
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Items by Category',
                        data: categoryData,
                        backgroundColor: [
                            'rgba(58, 123, 213, 0.7)',
                            'rgba(0, 255, 136, 0.7)',
                            'rgba(255, 170, 0, 0.7)',
                            'rgba(255, 68, 68, 0.7)',
                            'rgba(255, 215, 0, 0.7)',
                            'rgba(138, 43, 226, 0.7)'
                        ],
                        borderColor: [
                            'rgba(58, 123, 213, 1)',
                            'rgba(0, 255, 136, 1)',
                            'rgba(255, 170, 0, 1)',
                            'rgba(255, 68, 68, 1)',
                            'rgba(255, 215, 0, 1)',
                            'rgba(138, 43, 226, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'white',
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'white',
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Open add modal
        function openAddModal() {
            editingItemId = null;
            document.getElementById('modalTitle').textContent = 'Add New Item';
            document.getElementById('itemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('itemModal').style.display = 'flex';
        }

        // Open edit modal
        async function editItem(id) {
            showLoading('Loading item data...');
            try {
                const { data, error } = await supabase
                    .from('stock_items')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                editingItemId = id;
                document.getElementById('modalTitle').textContent = 'Edit Item';
                document.getElementById('itemId').value = id;
                document.getElementById('itemName').value = data.item_name;
                document.getElementById('itemCategory').value = data.category;
                document.getElementById('currentStock').value = data.current_stock;
                document.getElementById('minStock').value = data.min_stock;
                document.getElementById('unitPrice').value = data.unit_price;
                document.getElementById('expiryDate').value = data.expiry_date || '';
                document.getElementById('supplier').value = data.supplier || '';
                document.getElementById('description').value = data.description || '';
                
                document.getElementById('itemModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading item:', error);
                showFlash('Error loading item data', 'error');
            } finally {
                hideLoading();
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('itemModal').style.display = 'none';
        }

        // Save item
        async function saveItem(event) {
            event.preventDefault();
            
            const itemData = {
                item_name: document.getElementById('itemName').value,
                category: document.getElementById('itemCategory').value,
                current_stock: parseInt(document.getElementById('currentStock').value),
                min_stock: parseInt(document.getElementById('minStock').value),
                unit_price: parseFloat(document.getElementById('unitPrice').value),
                expiry_date: document.getElementById('expiryDate').value || null,
                supplier: document.getElementById('supplier').value || null,
                description: document.getElementById('description').value || null,
                updated_at: new Date().toISOString()
            };
            
            showLoading(editingItemId ? 'Updating item...' : 'Adding item...');
            
            try {
                if (editingItemId) {
                    // Update existing item
                    const { error } = await supabase
                        .from('stock_items')
                        .update(itemData)
                        .eq('id', editingItemId);
                    
                    if (error) throw error;
                    showFlash('Item updated successfully!', 'success');
                } else {
                    // Add new item
                    itemData.created_at = new Date().toISOString();
                    const { error } = await supabase
                        .from('stock_items')
                        .insert([itemData]);
                    
                    if (error) throw error;
                    showFlash('Item added successfully!', 'success');
                }
                
                // Send WebSocket update
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({
                        type: 'stock_update',
                        timestamp: new Date().toISOString()
                    }));
                }
                
                closeModal();
                loadItems();
            } catch (error) {
                console.error('Error saving item:', error);
                showFlash('Error saving item: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Delete item
        async function deleteItem(id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            showLoading('Deleting item...');
            try {
                const { error } = await supabase
                    .from('stock_items')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                // Send WebSocket update
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({
                        type: 'stock_update',
                        timestamp: new Date().toISOString()
                    }));
                }
                
                showFlash('Item deleted successfully!', 'success');
                loadItems();
            } catch (error) {
                console.error('Error deleting item:', error);
                showFlash('Error deleting item', 'error');
            } finally {
                hideLoading();
            }
        }

        // Export to PDF
        async function exportToPDF() {
            showLoading('Generating PDF report...');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add header
                doc.setFontSize(20);
                doc.setTextColor(10, 31, 61);
                doc.text('Bete-Saida Pharmacy - Stock Report', 20, 20);
                
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 30);
                
                // Add summary
                const totalValue = items.reduce((sum, item) => sum + (item.current_stock * item.unit_price), 0);
                doc.setFontSize(14);
                doc.setTextColor(10, 31, 61);
                doc.text('Summary', 20, 45);
                
                doc.setFontSize(11);
                doc.text(`Total Items: ${items.length}`, 20, 55);
                doc.text(`Total Stock Value: $${totalValue.toFixed(2)}`, 20, 62);
                
                // Create table
                const tableData = items.map(item => [
                    item.item_name,
                    item.category,
                    item.current_stock.toString(),
                    item.min_stock.toString(),
                    `$${item.unit_price.toFixed(2)}`,
                    `$${(item.current_stock * item.unit_price).toFixed(2)}`,
                    item.expiry_date ? new Date(item.expiry_date).toLocaleDateString() : 'N/A',
                    getStockStatus(item.current_stock, item.min_stock).toUpperCase()
                ]);
                
                doc.autoTable({
                    head: [['Item Name', 'Category', 'Stock', 'Min', 'Price', 'Value', 'Expiry', 'Status']],
                    body: tableData,
                    startY: 70,
                    theme: 'striped',
                    headStyles: { fillColor: [10, 31, 61] },
                    styles: { fontSize: 9 },
                    columnStyles: {
                        0: { cellWidth: 40 },
                        1: { cellWidth: 30 },
                        2: { cellWidth: 15 },
                        3: { cellWidth: 15 },
                        4: { cellWidth: 20 },
                        5: { cellWidth: 25 },
                        6: { cellWidth: 25 },
                        7: { cellWidth: 20 }
                    }
                });
                
                // Save PDF
                doc.save(`stock-report-${new Date().toISOString().split('T')[0]}.pdf`);
                showFlash('PDF report generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating PDF:', error);
                showFlash('Error generating PDF report', 'error');
            } finally {
                hideLoading();
            }
        }

        // Export to Excel
        async function exportToExcel() {
            showLoading('Generating Excel report...');
            
            try {
                const worksheetData = [
                    ['Item Name', 'Category', 'Current Stock', 'Min Stock', 'Unit Price', 'Total Value', 'Expiry Date', 'Status', 'Supplier', 'Description']
                ];
                
                items.forEach(item => {
                    worksheetData.push([
                        item.item_name,
                        item.category,
                        item.current_stock,
                        item.min_stock,
                        item.unit_price,
                        item.current_stock * item.unit_price,
                        item.expiry_date ? new Date(item.expiry_date).toLocaleDateString() : 'N/A',
                        getStockStatus(item.current_stock, item.min_stock).toUpperCase(),
                        item.supplier || '',
                        item.description || ''
                    ]);
                });
                
                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Stock Report');
                
                XLSX.writeFile(workbook, `stock-report-${new Date().toISOString().split('T')[0]}.xlsx`);
                showFlash('Excel report generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating Excel:', error);
                showFlash('Error generating Excel report', 'error');
            } finally {
                hideLoading();
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize WebSocket
            initWebSocket();
            
            // Load initial data
            loadItems();
            
            // Set minimum date for expiry date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expiryDate').min = today;
            
            // Close modal on ESC key
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeModal();
                }
            });
            
            // Close modal when clicking outside
            document.getElementById('itemModal').addEventListener('click', (event) => {
                if (event.target === document.getElementById('itemModal')) {
                    closeModal();
                }
            });
        });

        // Error handling
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('Global error:', { message, source, lineno, colno, error });
            showFlash('An error occurred. Please check console for details.', 'error');
            return false;
        };
    </script>
</body>
</html>
